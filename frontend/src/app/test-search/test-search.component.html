<div class="search-page">
  <div class="page-wrapper">
    <div class="container">
      <!-- Main Search View -->
      <div class="main-search-view" *ngIf="!showAssistant" @fadeOutUp>
        <!-- Header -->
        <div class="search-header" @fadeIn>
          <h1>Find Your Medical Test</h1>
          <p>Search from over 500+ diagnostic tests and health screenings near you</p>
        </div>

        <!-- Search Row with Talk Button -->
        <div class="search-row">
          <!-- Search Container -->
          <div class="search-container">
            <div class="search-input-wrapper" [class.has-tags]="selectedTests.length > 0">
              <mat-icon class="search-icon">search</mat-icon>

              <!-- Selected Test Tags -->
              <div class="selected-tags" *ngIf="selectedTests.length > 0">
                <div class="test-tag" *ngFor="let test of selectedTests">
                  <span class="tag-name">{{test.name}}</span>
                  <button class="tag-remove" (click)="removeSelectedTest(test, $event)">
                    <mat-icon>close</mat-icon>
                  </button>
                </div>
              </div>

              <input
                type="text"
                class="search-input"
                #searchInput
                [(ngModel)]="searchQuery"
                (focus)="onSearchFocus()"
                (input)="onSearchInput()"
                (keydown)="onKeyDown($event)"
                [placeholder]="selectedTests.length > 0 ? 'Add more tests...' : 'Search tests, panels, or conditions...'"
                autocomplete="off"
              >
              <button
                class="clear-btn"
                *ngIf="searchQuery"
                (click)="clearSearch()"
              >
                <mat-icon>close</mat-icon>
              </button>
            </div>

            <!-- Autocomplete Dropdown -->
            <div
              class="autocomplete-dropdown"
              *ngIf="isDropdownOpen"
              @dropdownAnimation
            >
              <!-- Loading State -->
              <div class="loading-state" *ngIf="isLoading">
                <mat-spinner diameter="20"></mat-spinner>
                <span class="loading-text">Searching tests...</span>
              </div>

              <!-- Quick Categories (shown when empty) -->
              <div class="dropdown-section" *ngIf="!searchQuery && !isLoading">
                <div class="dropdown-section-header">
                  <span class="dropdown-section-title">Browse Categories</span>
                </div>
                <div class="quick-categories">
                  <div
                    class="category-chip"
                    *ngFor="let cat of categories"
                    (click)="selectCategory(cat)"
                  >
                    <mat-icon>{{cat.icon}}</mat-icon>
                    {{cat.name}}
                  </div>
                </div>
              </div>

              <!-- Recent Searches -->
              <div class="dropdown-section" *ngIf="!searchQuery && !isLoading && recentSearches.length > 0">
                <div class="dropdown-section-header">
                  <span class="dropdown-section-title">Recent Searches</span>
                  <button class="dropdown-section-action" (click)="clearRecentSearches()">Clear all</button>
                </div>
                <div
                  class="autocomplete-item"
                  *ngFor="let recent of recentSearches"
                  (click)="selectRecentSearch(recent)"
                >
                  <div class="item-icon recent">
                    <mat-icon>schedule</mat-icon>
                  </div>
                  <div class="item-content">
                    <div class="item-name">{{recent.name}}</div>
                    <div class="item-description">Searched {{recent.searchedAgo}}</div>
                  </div>
                </div>
              </div>

              <!-- Search Results -->
              <div class="dropdown-section" *ngIf="searchQuery && !isLoading && searchResults.length > 0">
                <div class="dropdown-section-header">
                  <span class="dropdown-section-title">Test Results</span>
                </div>
                <div
                  class="autocomplete-item"
                  *ngFor="let test of searchResults; let i = index"
                  [class.highlighted]="i === highlightedIndex"
                  [class.selected]="isTestSelected(test)"
                  (click)="selectTest(test)"
                >
                  <div class="item-checkbox">
                    <div class="checkbox-box" [class.checked]="isTestSelected(test)">
                      <mat-icon *ngIf="isTestSelected(test)">check</mat-icon>
                    </div>
                  </div>
                  <div class="item-icon" [ngClass]="getIconClass(test.category)">
                    <mat-icon>{{test.icon}}</mat-icon>
                  </div>
                  <div class="item-content">
                    <div class="item-name" [innerHTML]="highlightMatch(test.name)"></div>
                    <div class="item-description">{{test.description}}</div>
                  </div>
                  <div class="item-meta">
                    <span class="item-category" [ngClass]="getCategoryClass(test.category)">{{test.category}}</span>
                    <span class="item-price">${{test.price}}</span>
                  </div>
                </div>
              </div>

              <!-- No Results State -->
              <div class="no-results" *ngIf="searchQuery && !isLoading && searchResults.length === 0">
                <div class="no-results-icon">
                  <mat-icon>search_off</mat-icon>
                </div>
                <div class="no-results-title">No tests found</div>
                <div class="no-results-text">Try adjusting your search or browse categories above</div>
              </div>

              <!-- Dropdown Footer -->
              <div class="dropdown-footer" *ngIf="!isLoading">
                <div class="keyboard-hints" *ngIf="selectedTests.length === 0">
                  <div class="keyboard-hint">
                    <span class="kbd">↑</span>
                    <span class="kbd">↓</span>
                    <span>Navigate</span>
                  </div>
                  <div class="keyboard-hint">
                    <span class="kbd">Enter</span>
                    <span>Select</span>
                  </div>
                  <div class="keyboard-hint">
                    <span class="kbd">Esc</span>
                    <span>Close</span>
                  </div>
                </div>

                <!-- Selected Tests Summary -->
                <div class="selection-summary-bar" *ngIf="selectedTests.length > 0">
                  <span class="selected-count">{{selectedTests.length}} test{{selectedTests.length > 1 ? 's' : ''}} selected</span>
                  <span class="selected-total">${{getSelectedTotal()}}</span>
                </div>

                <span class="results-count" *ngIf="searchQuery && searchResults.length > 0 && selectedTests.length === 0">
                  {{searchResults.length}} results
                </span>

                <button
                  class="proceed-btn"
                  *ngIf="selectedTests.length > 0"
                  (click)="proceedToBooking()"
                >
                  Continue to Booking
                  <mat-icon>arrow_forward</mat-icon>
                </button>
              </div>
            </div>
          </div>

          <!-- Talk to Assistant Button -->
          <button class="talk-assistant-btn" (click)="openAssistant()">
            <mat-icon>support_agent</mat-icon>
            <span>Talk to Assistant</span>
          </button>
        </div>

        <!-- Popular Tests Section -->
        <div class="popular-tests" @fadeIn>
          <div class="section-header">
            <h2 class="section-title">Popular Tests</h2>
            <a class="see-all" routerLink="/book-test">
              See all tests
              <mat-icon>arrow_forward</mat-icon>
            </a>
          </div>
          <div class="tests-grid">
            <div
              class="test-card"
              *ngFor="let test of popularTests"
              (click)="onPopularTestClick(test)"
            >
              <div class="test-card-icon" [ngClass]="getIconClass(test.category)">
                <mat-icon>{{test.icon}}</mat-icon>
              </div>
              <div class="test-card-name">{{test.name}}</div>
              <div class="test-card-desc">{{test.description}}</div>
              <div class="test-card-footer">
                <span class="test-card-price">${{test.price}}</span>
                <span class="test-card-badge" *ngIf="getBadgeText(test)">{{getBadgeText(test)}}</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- VAPI Assistant View -->
      <div class="assistant-view" *ngIf="showAssistant" @slideInUp>
        <app-vapi-assistant (closeAssistant)="closeAssistant()"></app-vapi-assistant>
      </div>
    </div>
  </div>
</div>
