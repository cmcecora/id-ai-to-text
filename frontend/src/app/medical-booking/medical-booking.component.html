<div class="booking-page">
  <div class="booking-container">
    <!-- Header -->
    <div class="booking-header">
      <h1>Book Your Medical Test</h1>
      <p class="header-subtitle">Schedule your appointment in just a few simple steps</p>
    </div>

    <!-- Progress Steps -->
    <div class="progress-steps">
      <!-- Step 1 -->
      <div class="step-item" [class.active]="currentStep >= 1" [class.clickable]="currentStep >= 1" (click)="goToStep(1)">
        <div class="step-circle">
          <span *ngIf="currentStep <= 1">1</span>
          <mat-icon *ngIf="currentStep > 1">check</mat-icon>
        </div>
        <span class="step-label">Select Test</span>
      </div>

      <div class="step-line" [class.active]="currentStep >= 2"></div>

      <!-- Step 2 -->
      <div class="step-item" [class.active]="currentStep >= 2" [class.clickable]="currentStep >= 2" (click)="goToStep(2)">
        <div class="step-circle">
          <span *ngIf="currentStep <= 2">2</span>
          <mat-icon *ngIf="currentStep > 2">check</mat-icon>
        </div>
        <span class="step-label">Choose Date</span>
      </div>

      <div class="step-line" [class.active]="currentStep >= 3"></div>

      <!-- Step 3 (NEW - Upload ID) -->
      <div class="step-item" [class.active]="currentStep >= 3" [class.clickable]="currentStep >= 3" (click)="goToStep(3)">
        <div class="step-circle">
          <span *ngIf="currentStep <= 3">3</span>
          <mat-icon *ngIf="currentStep > 3">check</mat-icon>
        </div>
        <span class="step-label">Upload ID</span>
      </div>

      <div class="step-line" [class.active]="currentStep >= 4"></div>

      <!-- Step 4 (was Step 3) -->
      <div class="step-item" [class.active]="currentStep >= 4" [class.clickable]="currentStep >= 4" (click)="goToStep(4)">
        <div class="step-circle">
          <span *ngIf="currentStep <= 4">4</span>
          <mat-icon *ngIf="currentStep > 4">check</mat-icon>
        </div>
        <span class="step-label">Your Details</span>
      </div>

      <div class="step-line" [class.active]="currentStep >= 5"></div>

      <!-- Step 5 (was Step 4) -->
      <div class="step-item" [class.active]="currentStep >= 5">
        <div class="step-circle">
          <span>5</span>
        </div>
        <span class="step-label">Confirm</span>
      </div>
    </div>

    <!-- Main Card -->
    <div class="main-card">
      <!-- Step Content Container with Animation -->
      <div class="step-content-wrapper">

        <!-- Step 1: Select Test -->
        <div
          class="step-content"
          *ngIf="currentStep === 1"
          [@slideAnimation]="animationDirection"
          (@slideAnimation.done)="onAnimationDone()"
        >
        <h2>Select Your Test</h2>
        <p class="step-description">Choose the medical test you'd like to schedule</p>

        <div class="tests-grid">
          <div
            class="test-card"
            *ngFor="let test of medicalTests"
            [class.selected]="selectedTest?.id === test.id"
            (click)="selectTest(test)"
          >
            <div class="test-icon icon-container icon-lg icon-purple">
              <mat-icon>{{test.icon}}</mat-icon>
            </div>
            <div class="test-info">
              <h3 class="test-name">{{test.name}}</h3>
              <p class="test-description">{{test.description}}</p>
              <div class="test-meta">
                <span class="results-time">
                  <mat-icon>schedule</mat-icon>
                  Results in {{test.resultsTime}}
                </span>
                <span class="test-price">${{test.price}}</span>
              </div>
            </div>
            <div class="selected-check" *ngIf="selectedTest?.id === test.id">
              <mat-icon>check</mat-icon>
            </div>
          </div>
        </div>
      </div>

      <!-- Step 2: Choose Date & Time -->
      <div
        class="step-content"
        *ngIf="currentStep === 2"
        [@slideAnimation]="animationDirection"
        (@slideAnimation.done)="onAnimationDone()"
      >
        <h2>Choose Date & Time</h2>
        <p class="step-description">Select your preferred appointment slot</p>

        <!-- Selected Test Summary -->
        <div class="selected-test-summary" *ngIf="selectedTest">
          <div class="summary-icon icon-container icon-lg icon-purple">
            <mat-icon>{{selectedTest.icon}}</mat-icon>
          </div>
          <div class="summary-info">
            <p class="summary-name">{{selectedTest.name}}</p>
            <p class="summary-time">Results in {{selectedTest.resultsTime}}</p>
          </div>
          <button class="change-btn" (click)="goToStep(1)">Change</button>
        </div>

        <div class="date-time-grid">
          <!-- Calendar Section -->
          <div class="calendar-section">
            <h3>Select Date</h3>
            <div class="calendar-container">
              <!-- Month Header -->
              <div class="calendar-header">
                <button class="nav-arrow" (click)="previousMonth()">
                  <mat-icon>chevron_left</mat-icon>
                </button>
                <span class="month-name">{{currentMonthName}}</span>
                <button class="nav-arrow" (click)="nextMonth()">
                  <mat-icon>chevron_right</mat-icon>
                </button>
              </div>

              <!-- Week Days -->
              <div class="weekdays">
                <span *ngFor="let day of weekDays">{{day}}</span>
              </div>

              <!-- Calendar Days -->
              <div class="calendar-days">
                <button
                  *ngFor="let day of calendarDays"
                  class="calendar-day"
                  [class.empty]="day.date === 0"
                  [class.unavailable]="!day.available && day.date !== 0"
                  [class.today]="day.isToday"
                  [class.selected]="day.isSelected"
                  [disabled]="!day.available || day.date === 0"
                  (click)="selectDate(day)"
                >
                  {{day.date || ''}}
                </button>
              </div>
            </div>

            <!-- Legend -->
            <div class="calendar-legend">
              <div class="legend-item">
                <div class="legend-dot today"></div>
                <span>Today</span>
              </div>
              <div class="legend-item">
                <div class="legend-dot selected"></div>
                <span>Selected</span>
              </div>
              <div class="legend-item">
                <div class="legend-dot unavailable"></div>
                <span>Unavailable</span>
              </div>
            </div>
          </div>

          <!-- Time Slots Section -->
          <div class="time-section">
            <h3>Available Time Slots</h3>
            <p class="selected-date-text" *ngIf="selectedDate">{{formattedSelectedDate}}</p>
            <p class="selected-date-text" *ngIf="!selectedDate">Select a date to see available times</p>

            <div class="time-slots-container" *ngIf="selectedDate">
              <!-- Morning -->
              <div class="time-period">
                <p class="period-label">
                  <mat-icon>wb_sunny</mat-icon>
                  Morning
                </p>
                <div class="slots-grid">
                  <button
                    *ngFor="let slot of morningSlots"
                    class="time-slot"
                    [class.selected]="selectedTime === slot.time"
                    [class.unavailable]="!slot.available"
                    [disabled]="!slot.available"
                    (click)="selectTime(slot.time)"
                  >
                    {{slot.time}}
                  </button>
                </div>
              </div>

              <!-- Afternoon -->
              <div class="time-period">
                <p class="period-label">
                  <mat-icon>wb_cloudy</mat-icon>
                  Afternoon
                </p>
                <div class="slots-grid">
                  <button
                    *ngFor="let slot of afternoonSlots"
                    class="time-slot"
                    [class.selected]="selectedTime === slot.time"
                    [class.unavailable]="!slot.available"
                    [disabled]="!slot.available"
                    (click)="selectTime(slot.time)"
                  >
                    {{slot.time}}
                  </button>
                </div>
              </div>

              <!-- Evening -->
              <div class="time-period">
                <p class="period-label">
                  <mat-icon>nights_stay</mat-icon>
                  Evening
                </p>
                <div class="slots-grid">
                  <button
                    *ngFor="let slot of eveningSlots"
                    class="time-slot"
                    [class.selected]="selectedTime === slot.time"
                    [class.unavailable]="!slot.available"
                    [disabled]="!slot.available"
                    (click)="selectTime(slot.time)"
                  >
                    {{slot.time}}
                  </button>
                </div>
              </div>
            </div>

            <!-- Selected Summary -->
            <div class="selection-summary" *ngIf="selectedDate && selectedTime">
              <div class="summary-check icon-container icon-md icon-green">
                <mat-icon>check</mat-icon>
              </div>
              <div class="summary-text">
                <p class="summary-label">Selected Slot</p>
                <p class="summary-value">{{shortFormattedDate}} at {{selectedTime}}</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Location Selection -->
        <div class="location-section">
          <h3>Select Location</h3>
          <div class="locations-grid">
            <div
              class="location-card"
              *ngFor="let location of locations"
              [class.selected]="selectedLocation?.id === location.id"
              (click)="selectLocation(location)"
            >
              <div class="selected-badge" *ngIf="selectedLocation?.id === location.id">
                <mat-icon>check</mat-icon>
              </div>
              <div class="location-content">
                <div class="location-icon icon-container icon-lg" [class.icon-blue]="selectedLocation?.id === location.id" [class.icon-neutral]="selectedLocation?.id !== location.id">
                  <mat-icon>business</mat-icon>
                </div>
                <div class="location-info">
                  <p class="location-name">{{location.name}}</p>
                  <p class="location-address">{{location.address}}<br>{{location.city}}</p>
                  <p class="location-distance" [class.text-success]="selectedLocation?.id === location.id">
                    <mat-icon>place</mat-icon>
                    {{location.distance}}
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Step 3: Upload ID (NEW) -->
      <div
        class="step-content"
        *ngIf="currentStep === 3"
        [@slideAnimation]="animationDirection"
        (@slideAnimation.done)="onAnimationDone()"
      >
        <h2>Upload Your ID</h2>
        <p class="step-description">
          Speed up your check-in by uploading a photo of your ID. We'll automatically fill in your information.
          <strong>This step is optional</strong> - you can skip and enter details manually.
        </p>

        <!-- Appointment Summary (from previous steps) -->
        <div class="appointment-summary compact">
          <div class="summary-item">
            <div class="summary-icon icon-container icon-lg icon-purple">
              <mat-icon>{{selectedTest?.icon}}</mat-icon>
            </div>
            <div class="summary-details">
              <p class="summary-title">{{selectedTest?.name}}</p>
              <p class="summary-subtitle">{{shortFormattedDate}} at {{selectedTime}}</p>
            </div>
          </div>
        </div>

        <!-- Processing Overlay -->
        <div *ngIf="isProcessingOcr" class="ocr-processing-overlay">
          <div class="processing-content">
            <mat-progress-spinner
              mode="determinate"
              [value]="ocrProgress"
              diameter="60"
              strokeWidth="4"
            ></mat-progress-spinner>
            <p class="processing-text">Processing your ID...</p>
            <p class="processing-subtext">Extracting information using AI</p>
          </div>
        </div>

        <!-- Upload Panel (reuse existing component) -->
        <div class="upload-section" *ngIf="!ocrData && !isProcessingOcr && !ocrError">
          <app-upload-panel
            (fileProcessed)="onFileProcessed($event)"
            [disabled]="isProcessingOcr"
          ></app-upload-panel>
        </div>

        <!-- Error State -->
        <div *ngIf="ocrError && !isProcessingOcr" class="ocr-error-card">
          <div class="error-icon icon-container icon-lg icon-red">
            <mat-icon>error_outline</mat-icon>
          </div>
          <div class="error-content">
            <p class="error-title">Failed to process ID</p>
            <p class="error-message">{{ ocrError }}</p>
          </div>
          <div class="error-actions">
            <button class="btn btn-outline" (click)="retryUpload()">
              <mat-icon>refresh</mat-icon>
              Try Again
            </button>
            <button class="btn btn-primary" (click)="skipIdUpload()">
              Skip & Enter Manually
            </button>
          </div>
        </div>

        <!-- Success State -->
        <div *ngIf="ocrData && !isProcessingOcr" class="ocr-success-card">
          <div class="success-header">
            <div class="success-icon icon-container icon-lg icon-green">
              <mat-icon>check_circle</mat-icon>
            </div>
            <div class="success-content">
              <p class="success-title">ID Processed Successfully!</p>
              <p class="success-message">
                We extracted your information. It will be pre-filled in the next step for you to verify.
              </p>
            </div>
          </div>

          <!-- Preview of extracted data -->
          <div class="extracted-preview">
            <div class="preview-item" *ngIf="ocrData.firstName || ocrData.lastName">
              <span class="preview-label">Name:</span>
              <span class="preview-value">{{ ocrData.firstName }} {{ ocrData.lastName }}</span>
            </div>
            <div class="preview-item" *ngIf="ocrData.dob">
              <span class="preview-label">Date of Birth:</span>
              <span class="preview-value">{{ ocrData.dob }}</span>
            </div>
            <div class="preview-item" *ngIf="ocrData.addressStreet">
              <span class="preview-label">Address:</span>
              <span class="preview-value">
                {{ ocrData.addressStreet }}, {{ ocrData.addressCity }}, {{ ocrData.addressState }} {{ ocrData.addressZip }}
              </span>
            </div>
          </div>

          <div class="success-actions">
            <button class="btn btn-outline" (click)="clearUpload()">
              <mat-icon>refresh</mat-icon>
              Upload Different ID
            </button>
          </div>
        </div>

        <!-- Skip Option (always visible unless processing or success) -->
        <div *ngIf="!isProcessingOcr && !ocrData" class="skip-section">
          <div class="divider-with-text">
            <span>or</span>
          </div>
          <button class="btn btn-text" (click)="skipIdUpload()">
            <mat-icon>arrow_forward</mat-icon>
            Skip and enter information manually
          </button>
        </div>
      </div>

      <!-- Step 4: Patient Details (was Step 3) -->
      <div
        class="step-content"
        *ngIf="currentStep === 4"
        [@slideAnimation]="animationDirection"
        (@slideAnimation.done)="onAnimationDone()"
      >
        <h2>Your Details</h2>
        <p class="step-description">
          {{ ocrData && !uploadSkipped ? 'Please verify and complete your information' : 'Please provide your information for the appointment' }}
        </p>

        <!-- Pre-fill notice if OCR data exists -->
        <div *ngIf="ocrData && !uploadSkipped" class="prefill-notice">
          <mat-icon>auto_awesome</mat-icon>
          <span>Some fields have been pre-filled from your ID. Please verify the information.</span>
        </div>

        <!-- Appointment Summary -->
        <div class="appointment-summary">
          <div class="summary-item">
            <div class="summary-icon icon-container icon-lg icon-purple">
              <mat-icon>{{selectedTest?.icon}}</mat-icon>
            </div>
            <div class="summary-details">
              <p class="summary-title">{{selectedTest?.name}}</p>
              <p class="summary-subtitle">{{shortFormattedDate}} at {{selectedTime}}</p>
            </div>
          </div>
          <div class="summary-item">
            <div class="summary-icon icon-container icon-lg icon-blue">
              <mat-icon>business</mat-icon>
            </div>
            <div class="summary-details">
              <p class="summary-title">{{selectedLocation?.name}}</p>
              <p class="summary-subtitle">{{selectedLocation?.address}}</p>
            </div>
          </div>
        </div>

        <!-- Patient Form -->
        <form [formGroup]="patientForm" class="patient-form">
          <div class="form-section">
            <h3 class="section-title">Personal Information</h3>
            <div class="form-row">
              <mat-form-field appearance="outline">
                <mat-label>First Name</mat-label>
                <input matInput formControlName="firstName" placeholder="Enter your first name">
                <mat-error *ngIf="patientForm.get('firstName')?.hasError('required')">First name is required</mat-error>
                <mat-error *ngIf="patientForm.get('firstName')?.hasError('minlength')">Minimum 2 characters</mat-error>
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Last Name</mat-label>
                <input matInput formControlName="lastName" placeholder="Enter your last name">
                <mat-error *ngIf="patientForm.get('lastName')?.hasError('required')">Last name is required</mat-error>
                <mat-error *ngIf="patientForm.get('lastName')?.hasError('minlength')">Minimum 2 characters</mat-error>
              </mat-form-field>
            </div>

            <div class="form-row">
              <mat-form-field appearance="outline">
                <mat-label>Email Address</mat-label>
                <input matInput formControlName="email" type="email" placeholder="Enter your email">
                <mat-icon matPrefix>email</mat-icon>
                <mat-error *ngIf="patientForm.get('email')?.hasError('required')">Email is required</mat-error>
                <mat-error *ngIf="patientForm.get('email')?.hasError('email')">Please enter a valid email</mat-error>
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Phone Number</mat-label>
                <input matInput formControlName="phone" placeholder="(555) 123-4567" (input)="formatPhoneNumber($event)">
                <mat-icon matPrefix>phone</mat-icon>
                <mat-error *ngIf="patientForm.get('phone')?.hasError('required')">Phone number is required</mat-error>
                <mat-error *ngIf="patientForm.get('phone')?.hasError('pattern')">Format: (555) 123-4567</mat-error>
              </mat-form-field>
            </div>

            <div class="form-row single">
              <mat-form-field appearance="outline" class="date-field">
                <mat-label>Date of Birth</mat-label>
                <input matInput [matDatepicker]="dobPicker" formControlName="dob" placeholder="MM/DD/YYYY">
                <mat-datepicker-toggle matSuffix [for]="dobPicker"></mat-datepicker-toggle>
                <mat-datepicker #dobPicker></mat-datepicker>
                <mat-error *ngIf="patientForm.get('dob')?.hasError('required')">Date of birth is required</mat-error>
              </mat-form-field>
            </div>
          </div>

          <div class="form-section">
            <h3 class="section-title">Insurance Information <span class="optional">(Optional)</span></h3>
            <div class="form-row">
              <mat-form-field appearance="outline">
                <mat-label>Insurance Provider</mat-label>
                <mat-select formControlName="insuranceProvider">
                  <mat-option value="">Select provider</mat-option>
                  <mat-option value="aetna">Aetna</mat-option>
                  <mat-option value="bluecross">Blue Cross Blue Shield</mat-option>
                  <mat-option value="cigna">Cigna</mat-option>
                  <mat-option value="united">United Healthcare</mat-option>
                  <mat-option value="humana">Humana</mat-option>
                  <mat-option value="kaiser">Kaiser Permanente</mat-option>
                  <mat-option value="other">Other</mat-option>
                  <mat-option value="self">Self Pay</mat-option>
                </mat-select>
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Member ID</mat-label>
                <input matInput formControlName="memberId" placeholder="Enter member ID">
              </mat-form-field>
            </div>
          </div>

          <div class="form-section">
            <h3 class="section-title">Additional Notes <span class="optional">(Optional)</span></h3>
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Notes for the lab</mat-label>
              <textarea matInput formControlName="notes" rows="3" placeholder="Any special requirements or medical conditions we should know about"></textarea>
            </mat-form-field>
          </div>
        </form>
      </div>

      <!-- Step 5: Confirmation (was Step 4) -->
      <div
        class="step-content"
        *ngIf="currentStep === 5"
        [@fadeIn]
      >
        <div class="confirmation-container" *ngIf="bookingConfirmed">
          <div class="success-icon">
            <mat-icon>check_circle</mat-icon>
          </div>
          <h2>Booking Confirmed!</h2>
          <p class="confirmation-number">Confirmation #: {{confirmationNumber}}</p>
          <p class="confirmation-message">Your appointment has been successfully scheduled. A confirmation email has been sent to {{patientForm.get('email')?.value}}.</p>

          <div class="confirmation-details">
            <div class="detail-card">
              <div class="detail-icon icon-container icon-lg icon-purple">
                <mat-icon>{{selectedTest?.icon}}</mat-icon>
              </div>
              <div class="detail-info">
                <p class="detail-label">Test</p>
                <p class="detail-value">{{selectedTest?.name}}</p>
              </div>
            </div>

            <div class="detail-card">
              <div class="detail-icon icon-container icon-lg icon-blue">
                <mat-icon>event</mat-icon>
              </div>
              <div class="detail-info">
                <p class="detail-label">Date & Time</p>
                <p class="detail-value">{{shortFormattedDate}} at {{selectedTime}}</p>
              </div>
            </div>

            <div class="detail-card">
              <div class="detail-icon icon-container icon-lg icon-green">
                <mat-icon>business</mat-icon>
              </div>
              <div class="detail-info">
                <p class="detail-label">Location</p>
                <p class="detail-value">{{selectedLocation?.name}}</p>
                <p class="detail-address">{{selectedLocation?.address}}</p>
              </div>
            </div>

            <div class="detail-card">
              <div class="detail-icon icon-container icon-lg icon-orange">
                <mat-icon>person</mat-icon>
              </div>
              <div class="detail-info">
                <p class="detail-label">Patient</p>
                <p class="detail-value">{{patientForm.get('firstName')?.value}} {{patientForm.get('lastName')?.value}}</p>
                <p class="detail-address">{{patientForm.get('email')?.value}}</p>
              </div>
            </div>
          </div>

          <div class="confirmation-actions">
            <button class="btn btn-outline" (click)="startNewBooking()">
              <mat-icon>add</mat-icon>
              Book Another Test
            </button>
            <button class="btn btn-primary">
              <mat-icon>calendar_today</mat-icon>
              Add to Calendar
            </button>
          </div>
        </div>
      </div>

      </div><!-- End step-content-wrapper -->

      <!-- Action Buttons -->
      <div class="action-buttons" *ngIf="currentStep < 5 || !bookingConfirmed">
        <button class="btn btn-outline" (click)="previousStep()" *ngIf="currentStep > 1">
          <mat-icon>arrow_back</mat-icon>
          Back
        </button>
        <div class="spacer" *ngIf="currentStep === 1"></div>

        <!-- Step 3 (ID Upload): Show Continue only when OCR is complete or skip was used -->
        <button
          *ngIf="currentStep === 3 && (ocrData || uploadSkipped)"
          class="btn btn-primary"
          (click)="nextStep()"
          [disabled]="isProcessingOcr"
        >
          Continue
          <mat-icon>arrow_forward</mat-icon>
        </button>

        <!-- Other steps: Standard continue/confirm button -->
        <button
          *ngIf="currentStep !== 3"
          class="btn btn-primary"
          (click)="nextStep()"
          [disabled]="!canProceed()"
        >
          {{currentStep === 4 ? 'Confirm Booking' : 'Continue'}}
          <mat-icon>{{currentStep === 4 ? 'check' : 'arrow_forward'}}</mat-icon>
        </button>
      </div>
    </div>

    <!-- Help Card -->
    <div class="help-card">
      <div class="help-icon icon-container icon-lg icon-purple">
        <mat-icon>headset_mic</mat-icon>
      </div>
      <div class="help-info">
        <p class="help-title">Need help scheduling?</p>
        <p class="help-description">Our support team is available 24/7 to assist you with booking.</p>
      </div>
      <button class="btn btn-outline">Contact Support</button>
    </div>
  </div>
</div>
