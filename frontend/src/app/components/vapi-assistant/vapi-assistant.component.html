<div class="vapi-assistant" @fadeSlideIn>
  <!-- Header -->
  <div class="assistant-header">
    <div class="header-left">
      <div class="assistant-avatar" [class.active]="isCallActive" [class.speaking]="isSpeaking">
        <mat-icon>support_agent</mat-icon>
        <div class="pulse-ring" *ngIf="isSpeaking"></div>
      </div>
      <div class="header-info">
        <h2>Medical Booking Assistant</h2>
        <span class="status-text" [class.active]="isCallActive">{{ statusText }}</span>
      </div>
    </div>
    <button class="close-btn" (click)="onClose()">
      <mat-icon>close</mat-icon>
    </button>
  </div>

  <!-- Main Content -->
  <div class="assistant-content">
    <!-- Left: Chat Interface -->
    <div class="chat-panel">
      <div class="messages-container" #messagesContainer>
        <div
          *ngFor="let message of messages"
          class="message"
          [ngClass]="'message-' + message.role"
          @messageAnimation
        >
          <div class="message-avatar" *ngIf="message.role === 'assistant'">
            <mat-icon>smart_toy</mat-icon>
          </div>
          <div class="message-bubble">
            <p>{{ message.content }}</p>
            <span class="message-time">{{ message.timestamp | date:'shortTime' }}</span>
          </div>
          <div class="message-avatar user" *ngIf="message.role === 'user'">
            <mat-icon>person</mat-icon>
          </div>
        </div>

        <!-- Typing Indicator -->
        <div class="message message-assistant" *ngIf="isSpeaking">
          <div class="message-avatar">
            <mat-icon>smart_toy</mat-icon>
          </div>
          <div class="message-bubble typing">
            <div class="typing-indicator">
              <span></span>
              <span></span>
              <span></span>
            </div>
          </div>
        </div>
      </div>

      <!-- Call Controls -->
      <div class="call-controls">
        <div class="voice-indicator" [class.active]="isListening">
          <div class="voice-wave" *ngIf="isListening">
            <span></span>
            <span></span>
            <span></span>
            <span></span>
            <span></span>
          </div>
          <span class="indicator-text" *ngIf="!isListening && !isSpeaking && isCallActive">
            Say something...
          </span>
        </div>

        <button
          class="call-btn"
          [class.active]="isCallActive"
          [class.connecting]="isConnecting"
          (click)="toggleCall()"
        >
          <mat-icon *ngIf="!isCallActive && !isConnecting">mic</mat-icon>
          <mat-icon *ngIf="isCallActive">call_end</mat-icon>
          <mat-icon *ngIf="isConnecting" class="spinning">close</mat-icon>
          <span>{{ callButtonText }}</span>
        </button>

        <!-- Pause/Resume Button - only visible during active call -->
        <button
          *ngIf="isCallActive && !isConnecting"
          class="pause-btn"
          [class.paused]="isPaused"
          (click)="togglePause()"
        >
          <mat-icon *ngIf="!isPaused">pause</mat-icon>
          <mat-icon *ngIf="isPaused">play_arrow</mat-icon>
          <span>{{ pauseButtonText }}</span>
        </button>
      </div>
    </div>

    <!-- Right: Booking Form -->
    <div class="form-panel">
      <div class="form-header">
        <h3>Booking Information</h3>
        <span class="form-status" *ngIf="hasFormData()">
          <mat-icon>check_circle</mat-icon>
          {{ getFilledFields().length }} fields collected
        </span>
      </div>

      <div class="form-content">
        <div class="booking-fields-list">
          <div class="field-item" *ngFor="let field of formFields">
            <label class="field-label">{{ field.label }}</label>
            <input
              [formControl]="getFormControl(field.key)"
              class="booking-field-input"
              [class.has-value]="getFormControl(field.key).value"
              [placeholder]="'â€”'"
              readonly
            />
          </div>
        </div>
      </div>

      <!-- Continue Button -->
      <div class="form-actions" *ngIf="hasFormData()">
        <button 
          class="continue-btn"
          (click)="proceedToBooking()"
          [disabled]="isCallActive"
        >
          <mat-icon>arrow_forward</mat-icon>
          <span>Continue to Booking</span>
        </button>
        <p class="action-hint" *ngIf="isCallActive">
          End the call to continue with your booking
        </p>
      </div>
    </div>
  </div>
</div>
